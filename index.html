const editor = document.getElementById('editor');
    const highlightContent = document.getElementById('highlight-content');
    const display = document.getElementById('filename-display');
    const layer = document.getElementById('highlight-layer');
    const metaTheme = document.getElementById('meta-theme');
    let fileHandle = null;
    let isModified = false;

    let state = {
        theme: 'latte',
        fontSize: 18,
        filename: 'untitled'
    };

    // --- CORE TOGGLE FUNCTION ---
    const toggleTheme = () => {
        state.theme = (state.theme === 'latte') ? 'frappe' : 'latte';
        
        // Immediate UI Update
        document.body.classList.remove('theme-latte', 'theme-frappe');
        document.body.classList.add(`theme-${state.theme}`);
        
        // Meta & Storage
        metaTheme.setAttribute('content', state.theme === 'latte' ? '#eff1f5' : '#303446');
        localStorage.setItem('editor-settings', JSON.stringify(state));
        console.log("Theme switched to:", state.theme); // Debug check
    };

    const applyState = () => {
        const saved = localStorage.getItem('editor-settings');
        if (saved) state = { ...state, ...JSON.parse(saved) };

        document.body.classList.remove('theme-latte', 'theme-frappe');
        document.body.classList.add(`theme-${state.theme}`);
        metaTheme.setAttribute('content', state.theme === 'latte' ? '#eff1f5' : '#303446');
        editor.style.fontSize = layer.style.fontSize = `${state.fontSize}px`;
        display.innerText = state.filename + (isModified ? ' â€¢' : '');
    };

    // --- THE FIX: MULTI-LAYER LISTENER ---
    const handleShortcuts = (e) => {
        const isMod = e.ctrlKey || e.metaKey;

        // Try CTRL + B or CTRL + M (M is less likely to be blocked)
        if (isMod && (e.code === 'KeyB' || e.code === 'KeyM')) {
            e.preventDefault();
            e.stopPropagation();
            toggleTheme();
        }

        if (isMod && e.code === 'KeyS') { e.preventDefault(); saveFile(); }
        if (isMod && e.code === 'KeyO') { e.preventDefault(); openFile(); }
    };

    // Listen everywhere
    window.addEventListener('keydown', handleShortcuts, true);
    editor.addEventListener('keydown', handleShortcuts, true);

    // --- REST OF LOGIC ---
    const updateHighlighting = () => {
        let text = editor.value;
        text = text.replace(/&/g, "&amp;").replace(/</g, "&lt;");
        highlightContent.innerHTML = text;
        Prism.highlightElement(highlightContent);
    };

    editor.oninput = () => {
        updateHighlighting();
        if (!isModified) { isModified = true; applyState(); }
        localStorage.setItem('last-content', editor.value);
    };

    editor.onscroll = () => {
        layer.scrollTop = editor.scrollTop;
        layer.scrollLeft = editor.scrollLeft;
    };

    async function saveFile() {
        try {
            if (!fileHandle) fileHandle = await window.showSaveFilePicker();
            const writable = await fileHandle.createWritable();
            await writable.write(editor.value);
            await writable.close();
            const file = await fileHandle.getFile();
            state.filename = file.name;
            isModified = false;
            applyState();
        } catch (e) { }
    }

    async function openFile() {
        try {
            [fileHandle] = await window.showOpenFilePicker();
            const file = await fileHandle.getFile();
            editor.value = await file.text();
            state.filename = file.name;
            isModified = false;
            applyState();
            updateHighlighting();
        } catch (e) {}
    }

    window.onload = () => {
        applyState();
        const savedContent = localStorage.getItem('last-content');
        if (savedContent) {
            editor.value = savedContent;
            updateHighlighting();
        }
    };
