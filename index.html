<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" id="meta-theme" content="#eff1f5">
    <title>Editor with Preview</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    
    <style>
        .theme-latte {
            --base: #eff1f5; --text: #4c4f69; --lavender: #7287fd;
            --crust: #ccd0da; --mantle: #e6e9ef; --line-bg: #e6e9ef;
            --token-comment: #9ca0b0; --token-selector: #e64553;
            --token-string: #40a02b; --token-keyword: #8839ef; --token-attr: #fe640b;
            --tab-color: #bcc0cc; --preview-bg: #ffffff;
        }

        .theme-frappe {
            --base: #303446; --text: #c6d0f5; --lavender: #babbf1;
            --crust: #232634; --mantle: #292c3c; --line-bg: #292c3c;
            --token-comment: #838ba7; --token-selector: #e78284;
            --token-string: #a6d189; --token-keyword: #ca9ee6; --token-attr: #ef9f76;
            --tab-color: #414559; --preview-bg: #ffffff;
        }

        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; background-color: var(--base); height: 100%; width: 100%; overflow: hidden; transition: background-color 0.2s; font-family: "Courier New", Courier, monospace; }
        
        #container { position: relative; display: flex; height: 100vh; padding-top: 40px; }

        #gutter {
            width: 50px; height: 100%; background: var(--line-bg);
            color: var(--token-comment); text-align: right; padding-right: 10px;
            padding-top: 20px; font-size: 14px; line-height: 1.7;
            user-select: none; overflow: hidden; flex-shrink: 0;
        }

        .hide-lines #gutter { display: none; }

        #editor-wrapper { position: relative; flex: 1; height: 100%; overflow: hidden; }

        /* Preview Pane Styling */
        #preview-pane { 
            flex: 1; 
            height: 100%; 
            border: none; 
            background: var(--preview-bg); 
            display: none; /* Hidden by default */
        }

        .show-preview #preview-pane { display: block; border-left: 2px solid var(--crust); }

        #editor, #highlight-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px; margin: 0; line-height: 1.7; tab-size: 4; 
            white-space: pre; word-wrap: break-word; overflow: auto; border: none; outline: none;
            background: transparent; font-size: inherit; font-family: inherit;
        }

        #editor { color: transparent; caret-color: var(--text); z-index: 2; resize: none; }
        #highlight-layer { z-index: 1; pointer-events: none; color: var(--text); }

        .tab-symbol { color: var(--tab-color); position: absolute; pointer-events: none; }

        #filename-display {
            position: fixed; top: 10px; left: 15px; font-size: 0.75rem; 
            color: var(--text); opacity: 0.5; z-index: 10;
        }

        .token.comment { color: var(--token-comment); font-style: italic; }
        .token.string { color: var(--token-string); }
        .token.keyword { color: var(--token-keyword); font-weight: bold; }
        .token.function { color: var(--lavender); }
    </style>
</head>
<body class="theme-latte">

<div id="filename-display">untitled</div>

<div id="container">
    <div id="gutter">1</div>
    <div id="editor-wrapper">
        <pre id="highlight-layer" aria-hidden="true"><code id="highlight-content" class="language-javascript"></code></pre>
        <textarea id="editor" spellcheck="false" autocomplete="off" placeholder="Start typing HTML..."></textarea>
    </div>
    <iframe id="preview-pane"></iframe>
</div>

<script>
const editor = document.getElementById('editor');
    const highlightContent = document.getElementById('highlight-content');
    const gutter = document.getElementById('gutter');
    const display = document.getElementById('filename-display');
    const metaTheme = document.getElementById('meta-theme');
    const previewPane = document.getElementById('preview-pane');

    let debounceTimer; // Variable to hold the timer

    let state = {
        theme: localStorage.getItem('theme') || 'latte',
        showLines: localStorage.getItem('showLines') !== 'false',
        showPreview: localStorage.getItem('showPreview') === 'true',
        filename: 'index.html'
    };

    const updateUI = () => {
        document.body.className = `theme-${state.theme} ${state.showLines ? '' : 'hide-lines'} ${state.showPreview ? 'show-preview' : ''}`;
        metaTheme.setAttribute('content', state.theme === 'latte' ? '#eff1f5' : '#303446');
        display.innerText = state.filename;
        // Immediate update on UI toggle to feel responsive
        renderPreview(); 
    };

    const updateLines = () => {
        const lines = editor.value.split('\n').length;
        let lineNumbers = '';
        for (let i = 1; i <= lines; i++) lineNumbers += i + '<br>';
        gutter.innerHTML = lineNumbers;
    };

    // The core rendering logic
    const renderPreview = () => {
        if (!state.showPreview) return;
        const doc = previewPane.contentDocument || previewPane.contentWindow.document;
        doc.open();
        doc.write(editor.value);
        doc.close();
    };

    // The Debounce Wrapper
    const debouncedPreview = () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            renderPreview();
        }, 300); // 300ms delay
    };

    const updateHighlighting = () => {
        let text = editor.value;
        let highlighted = text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/\t/g, '<span class="tab-symbol">Â»    </span>\t');

        highlightContent.innerHTML = highlighted;
        Prism.highlightElement(highlightContent);
        updateLines();
    };

    const handleKeydown = (e) => {
        const isMod = e.ctrlKey || e.metaKey;

        if (isMod && e.key.toLowerCase() === 'p') {
            e.preventDefault();
            state.showPreview = !state.showPreview;
            localStorage.setItem('showPreview', state.showPreview);
            updateUI();
        }

        if (isMod && e.key.toLowerCase() === 'b') {
            e.preventDefault();
            state.theme = state.theme === 'latte' ? 'frappe' : 'latte';
            localStorage.setItem('theme', state.theme);
            updateUI();
        }

        if (isMod && e.key.toLowerCase() === 'l') {
            e.preventDefault();
            state.showLines = !state.showLines;
            localStorage.setItem('showLines', state.showLines);
            updateUI();
        }

        if (e.key === 'Tab') {
            e.preventDefault();
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            editor.value = editor.value.substring(0, start) + "\t" + editor.value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + 1;
            updateHighlighting();
            debouncedPreview(); // Use debounce here too
        }
    };

    editor.addEventListener('input', () => {
        updateHighlighting();
        debouncedPreview(); // Trigger the delay
        localStorage.setItem('last-content', editor.value);
    });

    editor.addEventListener('scroll', () => {
        const layer = document.getElementById('highlight-layer');
        layer.scrollTop = gutter.scrollTop = editor.scrollTop;
        layer.scrollLeft = editor.scrollLeft;
    });

    window.addEventListener('keydown', handleKeydown);
    
    window.onload = () => {
        editor.value = localStorage.getItem('last-content') || '<h1>Hello</h1>';
        updateUI();
        updateHighlighting();
    };`
</script>
</body>
</html>
