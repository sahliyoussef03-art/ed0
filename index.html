<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" id="meta-theme" content="#eff1f5">
    <title>Editor</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    
    <style>
        .theme-latte {
            --base: #eff1f5; --text: #4c4f69; --lavender: #7287fd;
            --crust: #dce0e8; --mantle: #e6e9ef;
            --scroll-thumb: #ccd0da;
            --token-comment: #9ca0b0; --token-selector: #e64553;
            --token-string: #40a02b; --token-keyword: #8839ef;
            --token-attr: #fe640b;
        }

        .theme-frappe {
            --base: #303446; --text: #c6d0f5; --lavender: #babbf1;
            --crust: #232634; --mantle: #292c3c;
            --scroll-thumb: #51576d;
            --token-comment: #838ba7; --token-selector: #e78284;
            --token-string: #a6d189; --token-keyword: #ca9ee6;
            --token-attr: #ef9f76;
        }

        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; background-color: var(--base); height: 100%; width: 100%; overflow: hidden; transition: background-color 0.2s; }
        body.pulse { background-color: var(--mantle); }

        #filename-display {
            position: fixed; top: 15px; left: 20px;
            font-family: "Courier New", Courier, serif;
            font-size: 0.8rem; color: var(--text);
            opacity: 0.4; z-index: 10; pointer-events: none;
        }

        #container { position: relative; width: 100%; height: 100%; padding: 60px 50px 50px 50px; }

        #editor, #highlight-layer {
            position: absolute; top: 60px; left: 50px;
            width: calc(100% - 100px); height: calc(100% - 110px);
            margin: 0; font-family: "Courier New", Courier, monospace;
            line-height: 1.7; tab-size: 4; 
            white-space: pre; word-wrap: break-word; overflow: auto; border: none; outline: none;
        }

        /* --- Ghost Scrollbars --- */
        #editor::-webkit-scrollbar { width: 4px; height: 4px; }
        #editor::-webkit-scrollbar-thumb { 
            background: var(--scroll-thumb); 
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* Show when scrolling (toggled via JS) or hovering */
        #editor.scrolling::-webkit-scrollbar-thumb,
        #editor:hover::-webkit-scrollbar-thumb { 
            background: var(--scroll-thumb);
        }

        /* Firefox */
        #editor { scrollbar-width: none; transition: scrollbar-color 0.3s; }
        #editor.scrolling { scrollbar-width: thin; scrollbar-color: var(--scroll-thumb) transparent; }

        #editor { background: transparent; color: transparent; caret-color: var(--text); z-index: 2; resize: none; }
        #highlight-layer { z-index: 1; pointer-events: none; color: var(--text); }

        .token.comment { color: var(--token-comment); font-style: italic; }
        .token.string { color: var(--token-string); }
        .token.keyword { color: var(--token-keyword); font-weight: bold; }
        .token.selector, .token.tag { color: var(--token-selector); }
        .token.attr-name { color: var(--token-attr); }
        .token.function { color: var(--lavender); }

        ::selection { background: var(--lavender); color: var(--base); }
    </style>
</head>
<body class="theme-latte">

<div id="filename-display">untitled</div>
<div id="container">
    <pre id="highlight-layer" aria-hidden="true"><code id="highlight-content" class="language-javascript"></code></pre>
    <textarea id="editor" spellcheck="false" placeholder="..." autocomplete="off"></textarea>
</div>

<script>
    const editor = document.getElementById('editor');
    const highlightContent = document.getElementById('highlight-content');
    const display = document.getElementById('filename-display');
    const layer = document.getElementById('highlight-layer');
    const metaTheme = document.getElementById('meta-theme');
    let fileHandle = null;
    let isModified = false;
    let scrollTimeout;

    let state = {
        theme: 'latte',
        fontSize: 18,
        scrollTop: 0,
        scrollLeft: 0,
        filename: 'untitled'
    };

    const setModified = (mod) => {
        isModified = mod;
        display.innerText = state.filename + (mod ? ' â€¢' : '');
    };

    const saveState = () => {
        state.scrollTop = editor.scrollTop;
        state.scrollLeft = editor.scrollLeft;
        localStorage.setItem('editor-settings', JSON.stringify(state));
    };

    const applyState = () => {
        const saved = localStorage.getItem('editor-settings');
        if (saved) state = { ...state, ...JSON.parse(saved) };
        document.body.className = `theme-${state.theme}`;
        metaTheme.content = state.theme === 'latte' ? '#eff1f5' : '#303446';
        editor.style.fontSize = layer.style.fontSize = `${state.fontSize}px`;
        setModified(isModified);
        document.title = state.filename;
        setTimeout(() => {
            editor.scrollTop = layer.scrollTop = state.scrollTop;
            editor.scrollLeft = layer.scrollLeft = state.scrollLeft;
        }, 10);
    };

    const updateHighlighting = () => {
        let text = editor.value;
        text = text.replace(/&/g, "&amp;").replace(/</g, "&lt;");
        highlightContent.innerHTML = text;
        Prism.highlightElement(highlightContent);
    };

    // Scroll Logic with "Ghost" visibility
    editor.onscroll = () => {
        layer.scrollTop = editor.scrollTop;
        layer.scrollLeft = editor.scrollLeft;
        
        editor.classList.add('scrolling');
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => editor.classList.remove('scrolling'), 1000);
        
        saveState();
    };

    editor.oninput = () => {
        updateHighlighting();
        if (!isModified) setModified(true);
        localStorage.setItem('last-content', editor.value);
    };

    async function saveFile() {
        try {
            if (!fileHandle) fileHandle = await window.showSaveFilePicker();
            const writable = await fileHandle.createWritable();
            await writable.write(editor.value);
            await writable.close();
            const file = await fileHandle.getFile();
            state.filename = file.name;
            setModified(false);
            applyState();
            saveState();
            document.body.classList.add('pulse');
            setTimeout(() => document.body.classList.remove('pulse'), 150);
        } catch (e) { fileHandle = null; }
    }

    async function openFile() {
        try {
            [fileHandle] = await window.showOpenFilePicker();
            const file = await fileHandle.getFile();
            editor.value = await file.text();
            state.filename = file.name;
            setModified(false);
            applyState();
            updateHighlighting();
            saveState();
        } catch (e) {}
    }

    window.onkeydown = (e) => {
        const isMod = e.ctrlKey || e.metaKey;
        if (isMod && (e.key === '=' || e.key === '+')) {
            e.preventDefault();
            state.fontSize += 1;
            applyState();
            saveState();
        }
        if (isMod && e.key === '-') {
            e.preventDefault();
            state.fontSize = Math.max(8, state.fontSize - 1);
            applyState();
            saveState();
        }
        if (e.key === 'Tab') {
            e.preventDefault();
            editor.setRangeText('    ', editor.selectionStart, editor.selectionEnd, 'end');
            updateHighlighting();
            if (!isModified) setModified(true);
        }
        if (isMod && e.key.toLowerCase() === 's') { e.preventDefault(); saveFile(); }
        if (isMod && e.key.toLowerCase() === 'o') { e.preventDefault(); openFile(); }
        if (isMod && e.key.toLowerCase() === 'b') { 
            e.preventDefault();
            state.theme = state.theme === 'latte' ? 'frappe' : 'latte';
            applyState();
            saveState();
        }
    };

    window.onload = () => {
        applyState();
        const savedContent = localStorage.getItem('last-content');
        if (savedContent) {
            editor.value = savedContent;
            updateHighlighting();
        }
    };
</script>
</body>
</html>
